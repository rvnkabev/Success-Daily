<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Success Diary</title>
  <style>
    body{
      font-family: Arial, sans-serif;
      padding: 1em;
      background: #f9f9f9;
      font-size: 280%;
      text-align: center;
    }
    .page{display:none;}
    .active{display:block;}
    button{
      margin: 0.4em;
      padding: 0.3em 1em;
      font-size: 90%;
      cursor: pointer;
    }
    input,textarea,select{
      width: 90%;
      padding: 0.5em;
      font-size: 90%;
      margin: 0.6em 0;
    }
    .row{
      display:flex;
      gap:0.6em;
      justify-content:center;
      align-items:center;
      flex-wrap:wrap;
    }
    .row > * { flex: 1 1 240px; max-width: 480px; }
    .hint{font-size: 60%; color:#666; margin-top:-0.4em}
    .small{font-size: 70%;}
    .tagbar{display:none; margin:0.4em 0;}
    .tagbar button{font-size:70%;}
    .chip{display:inline-block; padding:0.2em 0.6em; border:1px solid #999; border-radius:999px; margin:0.1em;}
    .todo-wrap{max-width:760px; margin:0 auto; text-align:left; font-size:70%;}
    .todo-item{display:flex; align-items:center; gap:0.6em; padding:0.3em 0;}
    .todo-actions{text-align:center; margin-top:0.6em;}
  </style>
</head>
<body>

<!-- 1 - Main categories -->
<div class="page active" id="page1">
  <h2>Select Main Category</h2>
  <button onclick="selectCategory('Health')">Health</button>
  <button onclick="selectCategory('MentalHealth')">Mental&nbsp;Health</button>
  <button onclick="selectCategory('Relationship')">Relationship</button>
  <button onclick="selectCategory('Finance')">Finance</button>
  <button onclick="selectCategory('Work')">Work</button>
  <button onclick="selectCategory('Pomodoro')">Pomodoro</button>
  <button onclick="selectCategory('TonightToDoList')">Tonight&nbsp;ToDoList</button>
  <button onclick="selectCategory('Other')">Other</button>
</div>

<!-- 2 - Sub-categories (for non-Health / non-Pomodoro when needed) -->
<div class="page" id="pageSub">
  <h2 id="subCategoryTitle"></h2>
  <div id="subButtons"></div>
</div>

<!-- 3 - Free-text input (generic logger) -->
<div class="page" id="pageInput">
  <h2 id="selectedCategoryLabel"></h2>
  <p id="currentTime"></p>

  <!-- Relationship quick tags -->
  <div id="relationshipTagBar" class="tagbar">
    <span class="small">Quick tags:</span>
    <button class="chip" data-tag="#eat" onclick="toggleQuickTag(this)">#eat</button>
    <button class="chip" data-tag="#desire" onclick="toggleQuickTag(this)">#desire</button>
  </div>

  <input type="text" id="content" placeholder="Describe here…" />
  <button onclick="saveToNotes()">Save</button>
  <button onclick="goHome()">Cancel</button>
</div>

<!-- 4 - Health form -->
<div class="page" id="pageHealth">
  <h2>Health — Daily Check-in</h2>
  <p id="healthTime" class="small"></p>
  <div class="row">
    <!-- Sleeping hours: dropdown 4–12, default 7 -->
    <div style="flex:1 1 240px; max-width:480px;">
      <label for="sleepHours" class="small">Sleeping hours</label>
      <select id="sleepHours">
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7" selected>7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="11">11</option>
        <option value="12">12</option>
      </select>
    </div>

    <!-- On-bed time: default 21:30 -->
    <div style="flex:1 1 240px; max-width:480px;">
      <label for="onBedTime" class="small">On bed time</label>
      <input type="time" id="onBedTime" />
      <div class="hint">Default 9:30pm</div>
    </div>

    <!-- Energy: dropdown 1–10, default 7 -->
    <div style="flex:1 1 240px; max-width:480px;">
      <label for="energy" class="small">Energy (1–10)</label>
      <select id="energy">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7" selected>7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
      </select>
    </div>
  </div>

  <textarea id="healthNotes" placeholder="Optional notes (diet, symptoms, meds, etc.)"></textarea>
  <button onclick="saveHealth()">Save</button>
  <button onclick="goHome()">Cancel</button>
</div>

<!-- 5 - Tonight ToDoList (multi-select) -->
<div class="page" id="pageTodo">
  <h2>Tonight ToDoList</h2>
  <p id="todoTime" class="small"></p>
  <div class="todo-wrap" id="todoWrap">
    <!-- checkboxes injected by JS -->
  </div>
  <div class="todo-actions">
    <button onclick="saveTonightTodo()">Save</button>
    <button onclick="goHome()">Cancel</button>
  </div>
</div>

<script>
/** ---------- Config ---------- **/
const categoryMap = {
  Health: [],
  // MentalHealth removed: 服從, 忍, risk
  MentalHealth: ["DelayGratification","SelfControl","ErrorLearning","New","Desire","Anxiety","Other"],
  Relationship: ["HappyWifeHappyLife","Friendship","Father","Mother","Wife","Other"],
  Finance: [],
  Work: ["A12","MEWP","Communication","Other"],
  Pomodoro: ["English","Finance","Reading","Review"],
  TonightToDoList: [], // dedicated page
  Other: []
};

const tonightTodos = [
  { id:"buyChicken", label:"買雞" },
  { id:"soup90",    label:"整雞水（1.5hr）" },
  { id:"soup30",    label:"整雞水（30mins）" },
  { id:"exercise",  label:"運動" },
  { id:"swim",      label:"游水" },
  { id:"other",     label:"other", hasInput:true }
];

let selectedCategory = '';
let selectedSubCategory = '';

/** ---------- Time helpers ---------- **/
const fmtTime = () => {
  const d = new Date();
  let h = d.getHours(), m = d.getMinutes().toString().padStart(2, '0');
  const am = h >= 12 ? 'pm' : 'am';
  h = h % 12 || 12;
  return `${h}:${m}${am}`;
};

const fmtDate = () => {
  const now = new Date();
  return new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().split('T')[0];
};

/** ---------- UI helpers ---------- **/
const hidePages = () => document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
const goHome = () => { hidePages(); document.getElementById('page1').classList.add('active'); };

/** ---------- Category flow ---------- **/
function selectCategory(cat) {
  selectedCategory = cat;
  selectedSubCategory = '';

  if (cat === 'Health') { return gotoHealth(); }
  if (cat === 'TonightToDoList') { return gotoTonightTodo(); }

  const subs = categoryMap[cat] || [];
  if (cat === 'Pomodoro') {
    buildSubButtons(subs);
    hidePages();
    document.getElementById('pageSub').classList.add('active');
    return;
  }

  if (subs.length > 0) {
    buildSubButtons(subs);
    hidePages();
    document.getElementById('pageSub').classList.add('active');
  } else {
    gotoInput();
  }
}

function buildSubButtons(arr) {
  const wrap = document.getElementById('subButtons');
  wrap.innerHTML = '';
  document.getElementById('subCategoryTitle').textContent = selectedCategory;
  arr.forEach(s => {
    const b = document.createElement('button');
    b.textContent = s;
    b.onclick = () => selectSubCategory(s);
    wrap.appendChild(b);
  });
}

function selectSubCategory(sub) {
  selectedSubCategory = sub;
  if (selectedCategory === 'Pomodoro') {
    logPomodoro();
  } else {
    gotoInput();
  }
}

function gotoInput() {
  hidePages();
  const label = selectedSubCategory ? `${selectedCategory}/${selectedSubCategory}` : selectedCategory;
  document.getElementById('selectedCategoryLabel').textContent = label;
  document.getElementById('currentTime').textContent = fmtTime();
  document.getElementById('content').value = '';

  // Relationship quick tag bar toggle
  const showTagBar = (selectedCategory === 'Relationship');
  document.getElementById('relationshipTagBar').style.display = showTagBar ? 'block' : 'none';

  document.getElementById('pageInput').classList.add('active');
}

/** ---------- Relationship quick tags ---------- **/
function toggleQuickTag(btn){
  const tag = btn.getAttribute('data-tag');
  const input = document.getElementById('content');
  const has = new RegExp(`\\b${escapeRegExp(tag)}\\b`).test(input.value);
  if (has){
    // remove tag (clean double spaces)
    input.value = input.value.replace(new RegExp(`\\s*${escapeRegExp(tag)}\\b`,'g'),'').trim();
  } else {
    input.value = (input.value + ' ' + tag).trim();
  }
}

function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

/** ---------- Health page ---------- **/
function gotoHealth() {
  hidePages();
  document.getElementById('sleepHours').value = '7';
  document.getElementById('onBedTime').value = '21:30';
  document.getElementById('energy').value = '7';
  document.getElementById('healthNotes').value = '';
  document.getElementById('healthTime').textContent = `${fmtDate()} ${fmtTime()}`;
  document.getElementById('pageHealth').classList.add('active');
}

/** ---------- Tonight ToDoList page ---------- **/
function gotoTonightTodo(){
  hidePages();
  document.getElementById('todoTime').textContent = `${fmtDate()} ${fmtTime()}`;
  const wrap = document.getElementById('todoWrap');
  wrap.innerHTML = '';
  tonightTodos.forEach(item=>{
    const row = document.createElement('div');
    row.className = 'todo-item';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.id = 'td_' + item.id;

    const lab = document.createElement('label');
    lab.htmlFor = cb.id;
    lab.textContent = item.label;

    row.appendChild(cb);
    row.appendChild(lab);

    if (item.hasInput){
      const txt = document.createElement('input');
      txt.type = 'text';
      txt.id = 'td_other_text';
      txt.placeholder = '輸入其他事項…';
      row.appendChild(txt);
    }

    wrap.appendChild(row);
  });
  document.getElementById('pageTodo').classList.add('active');
}

/** ---------- Note building & saving ---------- **/
function buildEntry(text) {
  const date = fmtDate(), time = fmtTime();
  const tags = [`#${selectedCategory.toLowerCase()}`, selectedSubCategory ? `#${selectedSubCategory.toLowerCase()}` : '']
    .filter(Boolean).join(' ');
  return `[${date}\n${time} ｜ ${text} ${tags}]`;
}

function sendToShortcuts(encoded, isFinance) {
  const u1 = `shortcuts://run-shortcut?name=SaveToSuccessDaily&input=text&text=${encoded}`;
  if (isFinance) {
    const u2 = `shortcuts://run-shortcut?name=SaveToInvestment&input=text&text=${encoded}`;
    window.open(u1);
    setTimeout(() => window.location.href = u2, 500);
  } else {
    window.location.href = u1;
  }
}

/** Generic free-text save **/
function saveToNotes() {
  let txt = document.getElementById('content').value.trim();

  // 允許只有 quick tags（如 #eat/#desire）也能存
  if (!txt) {
    alert("Please enter something or use quick tags!");
    return;
  }

  // 修正常見錯誤，例如 #review]
  txt = txt.replace(/#review\]/gi, '#review');

  const note = buildEntry(txt);
  sendToShortcuts(encodeURIComponent(note), selectedCategory === 'Finance');
}

/** Pomodoro quick log **/
function logPomodoro() {
  const note = buildEntry('25mins');
  sendToShortcuts(encodeURIComponent(note), false);
  goHome();
}

/** Health structured save **/
function saveHealth() {
  const hours = parseInt((document.getElementById('sleepHours').value || '').trim(), 10);
  const onBed = (document.getElementById('onBedTime').value || '').trim();
  const energy = parseInt(document.getElementById('energy').value, 10);
  const notes = (document.getElementById('healthNotes').value || '').trim();

  if (isNaN(hours) || hours < 4 || hours > 12) {
    alert('Please select sleeping hours between 4 and 12.');
    return;
  }
  if (!onBed) {
    alert('Please enter on-bed time.');
    return;
  }
  if (isNaN(energy) || energy < 1 || energy > 10) {
    alert('Energy must be 1–10.');
    return;
  }

  const onBedHuman = toHumanTime(onBed);
  const pieces = [
    `sleep=${hours}h`,
    `onBed=${onBedHuman}`,
    `energy=${energy}/10`
  ];
  if (notes) pieces.push(`notes=${sanitizeInline(notes)}`);

  const text = pieces.join(' | ');
  selectedCategory = 'Health';
  selectedSubCategory = '';
  const note = buildEntry(text);
  sendToShortcuts(encodeURIComponent(note), false);
}

/** Tonight ToDoList save (multi-select) **/
function saveTonightTodo(){
  const chosen = [];
  tonightTodos.forEach(item=>{
    const cb = document.getElementById('td_'+item.id);
    if (cb && cb.checked){
      if (item.id === 'other'){
        const ot = (document.getElementById('td_other_text')?.value || '').trim();
        chosen.push( ot ? `other:${ot}` : 'other' );
      } else {
        chosen.push(item.label);
      }
    }
  });

  if (chosen.length === 0){
    alert('請至少選擇一項。');
    return;
  }

  selectedCategory = 'TonightToDoList';
  selectedSubCategory = '';
  const text = 'ToDo: ' + chosen.join(', ');
  const note = buildEntry(text);
  sendToShortcuts(encodeURIComponent(note), false);
}

/** helpers **/
function toHumanTime(hhmm) {
  const [hStr, mStr] = hhmm.split(':');
  let h = parseInt(hStr, 10);
  const ampm = h >= 12 ? 'pm' : 'am';
  h = h % 12 || 12;
  return `${h}:${mStr}${ampm}`;
}

function sanitizeInline(s) {
  return s.replace(/\n+/g, ' ').replace(/\]/g, ')');
}
</script>
</body>
</html>

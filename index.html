<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>成功日記</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1em;
      background-color: #f9f9f9;
      font-size: 300%;
      text-align: center;
    }

    .hidden {
      display: none;
    }

    button {
      margin: 0.5em;
      padding: 0.3em 1em;
      font-size: 100%;
    }

    input {
      width: 90%;
      padding: 0.5em;
      font-size: 100%;
      margin: 1em 0;
    }
  </style>
  <script>
    let selectedCategory = '';
    let statusForToday = "沒有該字"; // 預設為未記錄（會加日期）

    function getCurrentTimeFormatted() {
      const now = new Date();
      let hours = now.getHours();
      const minutes = now.getMinutes().toString().padStart(2, '0');
      const ampm = hours >= 12 ? 'pm' : 'am';
      hours = hours % 12;
      hours = hours ? hours : 12;
      return `${hours}:${minutes}${ampm}`;
    }

    function getTodayDateStr() {
      const today = new Date();
      return today.toISOString().split('T')[0];
    }

    function selectCategory(category) {
      selectedCategory = category;
      document.getElementById('selectedCategoryLabel').textContent = category;
      document.getElementById('currentTime').textContent = getCurrentTimeFormatted();

      document.getElementById('page1').classList.add('hidden');
      document.getElementById('page2').classList.remove('hidden');
    }

    function saveToNotes() {
      const content = document.getElementById('content').value;
      if (!content) {
        alert("請輸入內容！");
        return;
      }

      const time = getCurrentTimeFormatted();
      let entry = `${time} ｜ ${selectedCategory} ｜ ${content}`;

      // 根據捷徑回傳結果決定是否加上今日日期
      if (statusForToday === "沒有該字") {
        const date = getTodayDateStr();
        entry = `${date}\n` + entry;
      }

      const encoded = encodeURIComponent(entry);
      const url = `shortcuts://run-shortcut?name=SaveToSuccessDaily&input=text&text=${encoded}`;
      window.location.href = url;
    }

    function startScan() {
      const callbackURL = encodeURIComponent(window.location.origin + window.location.pathname);
      const shortcutURL = `shortcuts://x-callback-url/run-shortcut?name=ScanSuccessDaily&x-success=${callbackURL}`;
      window.location.href = shortcutURL;
    }

    function readURLParams() {
      const params = new URLSearchParams(window.location.search);
      const result = params.get("result");
      if (result) {
        const decoded = decodeURIComponent(result);
        statusForToday = decoded; // 「包含 ✓」 或 「沒有該字」
        document.getElementById("output").textContent = decoded;
      }
    }

    window.onload = readURLParams;
  </script>
</head>

<body>

<!-- 頁面一：選擇類別 -->
<div id="page1">
  <h1>選擇類別</h1>
  <button onclick="selectCategory('聆聽')">聆聽</button>
  <button onclick="selectCategory('健康')">健康</button>
  <button onclick="selectCategory('心靈')">心靈</button>
  <button onclick="selectCategory('人際')">人際</button>
  <button onclick="selectCategory('其他')">其他</button>
</div>

<!-- 頁面二：輸入內容 -->
<div id="page2" class="hidden">
  <h1 id="selectedCategoryLabel">類別</h1>
  <p id="currentTime"></p>
  <input type="text" id="content" placeholder="輸入內容..." />
  <button onclick="saveToNotes()">儲存到 iPhone Notes</button>
</div>

<!-- 掃描筆記功能 -->
<div style="margin-top: 2em;">
  <h2 id="output">請點擊下方按鈕掃描今日是否已記錄</h2>
  <button onclick="startScan()">掃描成功日記</button>
</div>

</body>
</html>
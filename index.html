<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>成功日記</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1em;
      background-color: #f9f9f9;
      font-size: 280%;
      text-align: center;
    }
    .page { display: none; }
    .active { display: block; }
    button {
      margin: 0.4em;
      padding: 0.3em 1em;
      font-size: 90%;
    }
    input, textarea {
      width: 90%;
      padding: 0.5em;
      font-size: 90%;
      margin: 1em 0;
    }
  </style>
</head>
<body>

<!-- 第一頁：主類別 -->
<div class="page active" id="page1">
  <h2>今日記錄主類別</h2>
  <button onclick="selectCategory('Health')">Health</button>
  <button onclick="selectCategory('MentalHealth')">MentalHealth</button>
  <button onclick="selectCategory('Relationship')">Relationship</button>
  <button onclick="selectCategory('Listen')">Listen</button>
  <button onclick="selectCategory('Finance')">Finance</button>
  <button onclick="selectCategory('Work')">Work</button>
  <button onclick="selectCategory('Pomodoro')">Pomodoro</button>
  <button onclick="selectCategory('Reflect')">Reflect</button>
  <button onclick="selectCategory('Other')">Other</button>
</div>

<!-- 第二頁：次項目 -->
<div class="page" id="pageSub">
  <h2 id="subCategoryTitle">選擇次項目</h2>
  <div id="subButtons"></div>
</div>

<!-- 第三頁：單項輸入 -->
<div class="page" id="pageInput">
  <h2 id="selectedCategoryLabel">類別</h2>
  <p id="currentTime"></p>
  <input type="text" id="content" placeholder="輸入內容..." />
  <button onclick="saveToNotes()">儲存</button>
</div>

<!-- 反省流程頁（保留原有功能） -->
<div class="page" id="reflect1">
  <h2>1. 為未來做咗咩？（運動、學習、人際、金融）</h2>
  <textarea id="answer1"></textarea>
  <button onclick="nextPage(1)">下一題</button>
</div>

<div class="page" id="reflect2">
  <h2>2. 有冇情緒困擾？點處理？</h2>
  <textarea id="answer2"></textarea>
  <button onclick="nextPage(2)">下一題</button>
</div>

<div class="page" id="reflect3">
  <h2>3. 有冇讚賞自己／講支持自己說話？</h2>
  <textarea id="answer3"></textarea>
  <button onclick="nextPage(3)">下一題</button>
</div>

<div class="page" id="reflect4">
  <h2>4. 有冇認真聽人講？唔係只想證明自己？</h2>
  <textarea id="answer4"></textarea>
  <button onclick="nextPage(4)">下一題</button>
</div>

<div class="page" id="reflect5">
  <h2>5. 今日對老婆做咗咩令佢開心？</h2>
  <textarea id="answer5"></textarea>
  <button onclick="submitReflection()">儲存</button>
</div>

<script>
  const categoryMap = {
    "Health": ["Swim", "Gym"],
    "MentalHealth": ["DelayGratification", "SelfControl"],
    "Relationship": ["HappyWifeHappyLife", "Friendship"],
    "Listen": ["NoInterrupt", "Understand", "Empathy"],
    "Finance": [],
    "Work": ["A12", "MEWP", "Communication"],
    "Pomodoro": ["English", "Finance", "Reading", "Review"],
    "Reflect": [],
    "Other": []
  };

  let selectedCategory = '';
  let selectedSubCategory = '';

  /* ---------- 時間與日期 ---------- */
  function getCurrentTimeFormatted() {
    const now = new Date();
    let hours = now.getHours();
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const ampm = hours >= 12 ? 'pm' : 'am';
    hours = hours % 12 || 12;
    return `${hours}:${minutes}${ampm}`;
  }
  function getTodayDateStr() {
    const now = new Date();
    const offsetMs = now.getTimezoneOffset() * 60000;
    const localTime = new Date(now.getTime() - offsetMs);
    return localTime.toISOString().split('T')[0];
  }

  /* ---------- 畫面切換 ---------- */
  function hideAllPages() {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  }

  function selectCategory(category) {
    if (category === 'Reflect') {
      startReflection();
      return;
    }
    selectedCategory = category;
    selectedSubCategory = '';
    const subs = categoryMap[category] || [];

    if (subs.length > 0) {
      buildSubButtons(subs);
      hideAllPages();
      document.getElementById('pageSub').classList.add('active');
    } else {
      goToInputPage();
    }
  }

  function buildSubButtons(subs) {
    const wrapper = document.getElementById('subButtons');
    wrapper.innerHTML = '';
    document.getElementById('subCategoryTitle').textContent = `${selectedCategory} 次項目`;
    subs.forEach(sub => {
      const btn = document.createElement('button');
      btn.textContent = sub;
      btn.onclick = () => selectSubCategory(sub);
      wrapper.appendChild(btn);
    });
  }

  function selectSubCategory(sub) {
    selectedSubCategory = sub;
    goToInputPage();
  }

  function goToInputPage() {
    hideAllPages();
    const label = selectedSubCategory
      ? `${selectedCategory} / ${selectedSubCategory}`
      : selectedCategory;
    document.getElementById('selectedCategoryLabel').textContent = label;
    document.getElementById('currentTime').textContent = getCurrentTimeFormatted();
    document.getElementById('content').value = '';
    document.getElementById('pageInput').classList.add('active');
  }

  function startReflection() {
    hideAllPages();
    document.getElementById('reflect1').classList.add('active');
  }

  function nextPage(current) {
    document.getElementById('reflect' + current).classList.remove('active');
    document.getElementById('reflect' + (current + 1)).classList.add('active');
  }

  /* ---------- 儲存 ---------- */
  function saveToNotes() {
    const content = document.getElementById('content').value.trim();
    if (!content) { alert("請輸入內容！"); return; }

    const date = getTodayDateStr();
    const time = getCurrentTimeFormatted();
    const tags = `#${selectedCategory}` + (selectedSubCategory ? ` #${selectedSubCategory}` : '');
    const title = selectedSubCategory
      ? `${selectedCategory}/${selectedSubCategory}`
      : selectedCategory;
    const entry = `${date}\n${time} ｜ ${title} ｜ ${content} ${tags}`;
    const encoded = encodeURIComponent(entry);

    if (selectedCategory === 'Finance') {
      const url1 = `shortcuts://run-shortcut?name=SaveToSuccessDaily&input=text&text=${encoded}`;
      const url2 = `shortcuts://run-shortcut?name=SaveToInvestment&input=text&text=${encoded}`;
      window.open(url1);
      setTimeout(() => window.location.href = url2, 500);
    } else {
      window.location.href = `shortcuts://run-shortcut?name=SaveToSuccessDaily&input=text&text=${encoded}`;
    }
  }

  function submitReflection() {
    const answers = [
      document.getElementById('answer1').value.trim(),
      document.getElementById('answer2').value.trim(),
      document.getElementById('answer3').value.trim(),
      document.getElementById('answer4').value.trim(),
      document.getElementById('answer5').value.trim()
    ];
    const note = `
成功日記：
1. 為未來：${answers[0]}
2. 情緒處理：${answers[1]}
3. 自我支持與自讚：${answers[2]}
4. 認真聆聽：${answers[3]}
5. 對老婆的愛：${answers[4]}
    `.trim();
    const encoded = encodeURIComponent(note);
    window.location.href = `shortcuts://run-shortcut?name=SaveToSuccessDaily&input=text&text=${encoded}`;
  }
</script>

</body>
</html>